"""
    CNNVD æ¼æ´æŸ¥è¯¢
    https://www.cnnvd.org.cn/home/loophole
"""
import pprint
import requests
import openpyxl
import json
from my_fake_useragent import UserAgent
import os
from bridge.context import ContextType
import hashlib
import time
from common.log import logger
import requests
from bridge.reply import Reply, ReplyType
from plugins import *

hazardLevel ={
    0:"æœªçŸ¥â“",
    1:"è¶…å±â—â—â—",
    2:"é«˜å±â—â—",
    3:"ä¸­å±â—",
    4:"ä½å±âš ï¸"
}

def search_cnnvd(number,e_context:EventContext):
    """
    number : CNNVDç¼–å· ä¾‹å¦‚ CNNVD-202311-1534
    """
    #
    content = f"ğŸ”ã€{number}ã€‘\n"
    # æœ€å¤§äºŒæ¬¡è¯·æ±‚æ¡æ•°
    max_data = 2
    logger.info(f"ğŸ”ã€{number}ã€‘")

    headers = {
        "Accept": "application/json, text/plain, */*",
        "Accept-Language": "zh-CN,zh;q=0.9",
        "Cache-Control": "no-cache",
        "Connection": "keep-alive",
        "Content-Type": "application/json;charset=UTF-8",
        "Origin": "https://www.cnnvd.org.cn",
        "Pragma": "no-cache",
        "Referer": "https://www.cnnvd.org.cn/home/loophole",
        "Sec-Fetch-Dest": "empty",
        "Sec-Fetch-Mode": "cors",
        "Sec-Fetch-Site": "same-origin",
        "User-Agent": UserAgent().random(),
        "sec-ch-ua": "^\\^Google",
        "sec-ch-ua-mobile": "?0",
        "sec-ch-ua-platform": "^\\^Windows^^",
    }
    url = "https://www.cnnvd.org.cn/web/homePage/cnnvdVulList"
    data = '{{"pageIndex":1,"pageSize":{},"keyword":"{}","hazardLevel":"","vulType":"","vendor":"","product":"","dateType":""}}'.format(
        max_data, number)

    response = requests.post(url, headers=headers, data=data)
    """
    {
    'code': 200,
    'data': {'pageIndex': 1,
              'pageSize': 10,
              'records': [{'cnnvdCode': 'CNNVD-202311-1534',
                           'createTime': '2023-11-17',
                           'cveCode': 'CVE-2023-6178',
                           'hazardLevel': 0,
                           'id': 'b53f7d7e933e4876b5e8452153719738',
                           'publishTime': '2023-11-17',
                           'typeName': None,
                           'updateTime': '2023-11-19',
                           'vulName': 'Nessus å®‰å…¨æ¼æ´',
                           'vulType': '0'}],
              'total': 1},
    'message': 'æ“ä½œæˆåŠŸ',
    'success': True,
    'time': '2023-11-20 15:54:26'
    }
    """
    try:
        response_data = response.json()
        response_status = response_data.get('code',400)
        print(response_data)
        if response_status == 200:
            total = response_data.get('data').get('total')
            print(f"æ€»å…±{total}æ¡")
            logger.info(f"  (å…±æŸ¥è¯¢åˆ°{total}æ¡æ¼æ´ä¿¡æ¯)")
            # å¦‚æœæ¡æ•°ä¸º0
            if total == 0:
                content += "æœªæŸ¥è¯¢åˆ°ç›¸å…³æ¼æ´ä¿¡æ¯"

            # å¦‚æœæ¡æ•°å°äºç­‰äºè®¾å®šçš„max_data
            elif total <= max_data:
                content += f"  (å…±æŸ¥è¯¢åˆ°{total}æ¡æ¼æ´ä¿¡æ¯)\n"
                records = response_data.get('data').get('records')
                for record in records:
                    loophole_id = record.get('id')
                    cnnvd_code = record.get('cnnvdCode')
                    content += get_loophole(loophole_id,cnnvd_code=cnnvd_code)

            # å¦‚æœæ¡æ•°å¤§äºè®¾å®šçš„max_data
            # åˆ™å‘é€Excel
            elif total > max_data:
                _send_info(e_context=e_context,content=f"ğŸ”ã€{number}ã€‘ç›¸å…³ä¿¡æ¯å…±{total}æ¡ï¼Œå·²æ•´ç†ä¸ºExcelæ¦‚è§ˆ")
                frequency = total // 50
                frequency = 1 if frequency == 0 else frequency

                print(f"éœ€è¦è¯·æ±‚{frequency}æ¬¡")
                result_data = []
                for page in range(1,frequency+1):
                    print(f"ç¬¬{page}æ¬¡è¯·æ±‚")
                    url = "https://www.cnnvd.org.cn/web/homePage/cnnvdVulList"
                    data = '{{"pageIndex":{},"pageSize":{},"keyword":"{}","hazardLevel":"","vulType":"","vendor":"","product":"","dateType":""}}'.format(
                        page,50, number)
                    result_data += requests.post(url, headers=headers, data=data).json().get('data').get('records')
                file_path = "tmp"

                if not os.path.exists(file_path):
                    os.makedirs(file_path)

                file_name = hashlib.md5(str(time.time()).encode()).hexdigest() + ".xlsx"
                file_path = os.path.join(file_path, file_name)

                print(file_path)
                # åˆ›å»ºä¸€ä¸ªæ–°çš„å·¥ä½œç°¿
                workbook = openpyxl.Workbook()
                # é€‰æ‹©é»˜è®¤çš„å·¥ä½œè¡¨
                sheet = workbook.active
                sheet.append(['æ¼æ´ç¼–å·','æ¼æ´ç­‰çº§','æ¼æ´åç§°','æ”¶å½•æ—¶é—´','æ›´æ–°æ—¶é—´','æŸ¥è¯¢id',])

                print(len(result_data))
                for record in result_data:
                    data = [
                        record.get('cnnvdCode'),
                        hazardLevel[record.get('hazardLevel')],
                        record.get('vulName'),
                        record.get('createTime'),
                        record.get('updateTime'),
                        record.get('id'),
                    ]
                    print(data)
                    sheet.append(data)
                sheet.append([])
                sheet.append([f"ä¿¡æ¯é‡å¤§äº{max_data}æ¡"])
                sheet.append([f"å·²è‡ªåŠ¨ä¸ºæ‚¨ç”Ÿæˆã€{number}ã€‘ç›¸å…³ç®€æŠ¥"])
                # ä¿å­˜å·¥ä½œç°¿
                workbook.save(file_path)
                reply = Reply()
                # å‘é€æ–‡ä»¶
                reply.type = ReplyType.FILE
                reply.content = file_path
                logger.info(f"æŸ¥è¯¢ç»“æœï¼š{file_path}")
                e_context["reply"] = reply
                e_context.action = EventAction.BREAK_PASS
                # è¿”å›ï¼šæš‚æ—¶æ— ç”¨
                return file_path,reply

    except Exception as e:
        print(e)
        logger.info(f"æŸ¥è¯¢æ¼æ´å‘ç”Ÿé”™è¯¯:{e}")
        content += f"å‘ç”Ÿé”™è¯¯:{e}\n"

    reply = Reply()
    reply.type = ReplyType.TEXT
    reply.content = content
    logger.info(reply.content)
    e_context["reply"] = reply
    e_context.action = EventAction.BREAK_PASS
    # è¿”å›ï¼šæš‚æ—¶æ— ç”¨
    return content

# è¿›ä¸€æ­¥æŸ¥è¯¢æ¼æ´è¯¦ç»†ä¿¡æ¯
def get_loophole(loophole_id,cnnvd_code="CNNVD-202311-299"):
    content = ""
    headers = {
        "Accept": "application/json, text/plain, */*",
        "Accept-Language": "zh-CN,zh;q=0.9",
        "Cache-Control": "no-cache",
        "Connection": "keep-alive",
        "Content-Type": "application/json;charset=UTF-8",
        "Origin": "https://www.cnnvd.org.cn",
        "Pragma": "no-cache",
        "Referer": "https://www.cnnvd.org.cn/home/loophole",
        "Sec-Fetch-Dest": "empty",
        "Sec-Fetch-Mode": "cors",
        "Sec-Fetch-Site": "same-origin",
        "User-Agent": UserAgent().random(),
        "sec-ch-ua": "^\\^Google",
        "sec-ch-ua-mobile": "?0",
        "sec-ch-ua-platform": "^\\^Windows^^",
    }
    url = "https://www.cnnvd.org.cn/web/cnnvdVul/getCnnnvdDetailOnDatasource"
    data = '{"id":"%s","vulType":"0","cnnvdCode":"%s"}' % (loophole_id,cnnvd_code)
    # response_data = requests.post(url=url, headers=headers, data=data).text
    # print(response_data)
    response_data = requests.post(url=url, headers=headers, data=data).json().get('data').get('cnnvdDetail')
    content += f"ã€æ¼æ´åç§°ã€‘{response_data.get('vulName')}\n"
    content += f"ã€æ¼æ´ç­‰çº§ã€‘{hazardLevel[response_data.get('hazardLevel')]}\n"
    content += f"ã€CNNVDç¼–å·ã€‘{response_data.get('cnnvdCode')}\n"
    content += f"ã€CVEç¼–å·ã€‘{response_data.get('cveCode')}\n"
    content += f"ã€CVEã€‘{response_data.get('cveCode')}\n"
    content += f"ã€æ¼æ´ç±»å‹ã€‘{response_data.get('vulType')}\n"
    content += f"ã€æ¼æ´æè¿°ã€‘{response_data.get('vulDesc')}\n"
    content += f"ã€æ”¶å½•æ—¶é—´ã€‘{response_data.get('publishTime')}\n"
    content += f"ã€æ›´æ–°æ—¶é—´ã€‘\n{response_data.get('updateTime')}\n"
    content += f"ã€å®˜æ–¹è¡¥ä¸ã€‘{response_data.get('patch')}\n"
    content += f"ã€å‚è€ƒç½‘å€ã€‘\n{response_data.get('referUrl')}\n"
    content += f"----------\n"
    """
    {'code': 200,
     'data': {'cnnvdDetail': {'affectedProduct': None,
                              'affectedSystem': None,
                              'affectedVendor': 'Subrion',
                              'cnnvdCode': 'CNNVD-202311-299',
                              'cnnvdFiledShow': 'vul_name,cnnvd_code,_code,publish_time,is_official,vendor,hazard_level,vul_type,vul_desc,affected_product,affected_vendor,product_desc,affected_system,refer_url,patch_id,product,update_time,patch',
                              'createTime': None,
                              'createUid': None,
                              'createUname': None,
                              'cveCode': 'CVE-2023-46947',
                              'cveFiledShow': None,
                              'cveVulVO': None,
                              'deleted': None,
                              'hazardLevel': 1,
                              'huaweiFiledShow': None,
                              'huaweiVulVO': None,
                              'ibmFiledShow': None,
                              'ibmVulVO': None,
                              'icsCertFiledShow': None,
                              'icsCertVulVO': None,
                              'id': None,
                              'isOfficial': 0,
                              'microsoftFiledShow': None,
                              'microsoftVulVO': None,
                              'nvdFiledShow': None,
                              'nvdVulVO': None,
                              'patch': None,
                              'patchId': None,
                              'productDesc': None,
                              'publishTime': '2023-11-03 00:00:00',
                              'referUrl': 'æ¥æº:MISC\r\n'
                                          'é“¾æ¥:https://github.com/intelliants/subrion/issues/909\r\n'
                                          '\r\n'
                                          'æ¥æº:cxsecurity.com\r\n'
                                          'é“¾æ¥:https://cxsecurity.com/cveshow/CVE-2023-46947/',
                              'updateTime': '2023-11-13 00:00:00',
                              'updateUid': None,
                              'updateUname': None,
                              'varchar1': 'å…¶ä»–',
                              'vendor': '1005853',
                              'version': None,
                              'vulDesc': 'Subrion '
                                         'CMSæ˜¯Subrionå›¢é˜Ÿçš„ä¸€å¥—åŸºäºPHPçš„å†…å®¹ç®¡ç†ç³»ç»Ÿï¼ˆCMSï¼‰ã€‚è¯¥ç³»ç»Ÿå¯è¢«é›†æˆåˆ°ç½‘ç«™ï¼Œå¹¶æ”¯æŒå¤šç§æ‰©å±•æ’ä»¶ç­‰ã€‚\r\n'
                                         'Subrion CMS '
                                         '4.2.1ç‰ˆæœ¬å­˜åœ¨å®‰å…¨æ¼æ´ã€‚æ”»å‡»è€…åˆ©ç”¨è¯¥æ¼æ´å¯ä»¥è¿œç¨‹æ‰§è¡Œä»£ç ã€‚',
                              'vulName': 'Subrion CMS å®‰å…¨æ¼æ´',
                              'vulType': 'å…¶ä»–',
                              'vulTypeName': 'å…¶ä»–'},
              'receviceVulDetail': None},
     'message': 'æ“ä½œæˆåŠŸ',
     'success': True,
     'time': '2023-11-20 17:05:15'}
    
    """
    pprint.pprint(response_data)
    return content



def _send_info(e_context: EventContext, content: str):
    reply = Reply(ReplyType.TEXT, content)
    channel = e_context["channel"]
    channel.send(reply, e_context["context"])


if __name__ == '__main__':
    # content = ""
    # number = "CNNVD-202311-224"
    # result = search_cnnvd(number=number)
    # if isinstance(result,str):
    #     content += result
    # print(content)
    print(get_loophole(loophole_id="c03637953d3b498f8f0becc3b6989e35"))


